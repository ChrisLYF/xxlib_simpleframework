//using System;

//public class MyUVServerPeerWrapperCustom : MyUVServerPeerWrapper
//{
//    public string addr;
//}

//public class MyUVWrapperHandler : IMyUVWrapperHandler
//{
//    public void OnAccept(MyUVServerPeerWrapper peer, string addr)
//    {
//        var p = ((MyUVServerPeerWrapperCustom)peer);
//        p.addr = addr;
//        Console.WriteLine(p.addr + " connected.");
//    }
//    public MyUVServerPeerWrapper OnCreatePeer()
//    {
//        return new MyUVServerPeerWrapperCustom();
//    }
//    public void OnDisconnect(MyUVServerPeerWrapper peer)
//    {
//        var p = ((MyUVServerPeerWrapperCustom)peer);
//        Console.WriteLine(p.addr + " disconnected.");
//    }
//    public void OnReceivePackage(MyUVServerPeerWrapper peer, byte[] data)
//    {
//        var p = ((MyUVServerPeerWrapperCustom)peer);
//        Console.WriteLine(p.addr + " recv data len = " + data.Length);

//        // echo package back
//        var bb = new xx.BBuffer(2 + data.Length);
//        bb.BeginWritePackage();
//        bb.WriteBuf(data, 0, data.Length);
//        bb.EndWritePackage();
//        peer.Send(bb.buf, 0, bb.dataLen);
//    }
//}

//class Program
//{
//    static void Main(string[] args)
//    {
//        var uv = new UVWrapper(new MyUVWrapperHandler()
//            , () =>
//            {
//                Console.Write(".");
//            }
//            , 12345, 128);
//        uv.Run();
//    }
//}


using System;

class Program
{
    static void Main(string[] args)
    {
        PKG.AllTypes.Register();

        xx.BBuffer.RegisterHandler<PKG.Foo>(ibb =>
        {
            var foo = ibb as PKG.Foo;
            Console.WriteLine(foo.f19);
        });

        var bb = new xx.BBuffer();
        var a = new PKG.Foo();
        a.f1 = 1;
        a.f2 = 2;
        a.f3 = 3;
        a.f4 = 4;
        a.f5 = 5;
        a.f6 = 6;
        a.f7 = 7;
        a.f8 = 8;
        a.f9 = DateTime.Now;
        a.f10 = "10";
        a.f11 = new xx.BBuffer(32);
        a.f11.Write((byte)11);
        a.f12 = PKG.E.C;
        a.f13 = new xx.List<PKG.E>();
        a.f13.Add(PKG.E.B);
        a.f13.Add(PKG.E.A);
        a.f14 = new xx.List<PKG.Bar>();
        a.f14.Add(new PKG.Bar());
        a.f14.Add(new PKG.Bar1());
        a.f14.Add(new PKG.Bar2());
        a.f15 = new xx.List<xx.List<PKG.E>>();
        a.f15.Add(a.f13);
        a.f16 = new xx.List<xx.List<PKG.Bar>>();
        a.f16.Add(a.f14);
        a.f17 = new xx.List<xx.List<xx.List<PKG.E>>>();
        a.f17.Add(a.f15);
        a.f18 = new xx.List<xx.List<xx.List<PKG.Bar>>>();
        a.f18.Add(a.f16);
        a.f19 = a;
        bb.WriteRoot(a);     // 连写3条
        bb.WriteRoot(a);
        bb.WriteRoot(a);
        bb.Dump();

        var success = xx.BBuffer.Handle(bb);
        if (success)
        {
            Console.WriteLine("success");
        }
    }
}
